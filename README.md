# FitBet

Telegram‑бот для групповых фитнес‑челленджей со ставкой, регулярными чек‑инами и финальным распределением «банка» между победителями.

Бот работает в двух контекстах:
- **Групповой чат** — создание челленджа, набор участников, выбор Bank Holder, общие уведомления.
- **Личка с ботом** — онбординг, оплата/подтверждение, чек‑ины (вес/талия/фото), персональный `/status`.

Подробная спецификация: `spec.md`.

---

## Возможности

- Создание челленджа в группе (`/create`) и набор участников через кнопку.
- Онбординг участников в личке: стартовые параметры, цель, обязательства.
- Выбор **Bank Holder** (держателя банка) голосованием (`/bankholder`).
- Оплаты в ручном режиме: участник отмечает «я оплатил», Bank Holder подтверждает.
- Периодические чек‑ины по расписанию (окна по 48 часов) + напоминания перед закрытием окна.
- Дисциплина (пропуски/доля сданных чек‑инов), дисквалификация при превышении лимита пропусков.
- Финальный подсчёт и распределение банка.
- Опционально:
  - **OpenRouter** — LLM‑валидация цели и рекомендации по чек‑ину (с учётом фото).
  - **Sentry** — сбор ошибок.

---

## Команды

### В группе
- `/create` — создать челлендж и открыть набор
- `/bankholder` — запустить голосование за Bank Holder
- `/status` — статус челленджа и список участников
- `/help` — справка

### В личке
- `/start` — продолжить онбординг или сдать чек‑ин
- `/status` — ваши участия и прогресс
- `/help` — справка
- `/clear_db` — очистить БД (только для `ADMIN_TELEGRAM_ID`)

---

## Как проходит челлендж (кратко)

1) В группе создаётся челлендж (`/create`) и появляется кнопка «Участвовать».
2) Каждый участник проходит онбординг в личке (`/start`): стартовые данные, цель, обязательства.
3) В группе выбирается Bank Holder (`/bankholder`) — он подтверждает оплаты.
4) После подтверждения всех оплат челлендж активируется и планируются чек‑ины.
5) В окна чек‑ина (48 часов) участники сдают вес/талию/фото.
6) В конце срока бот финализирует результаты и сообщает выплаты.

Подсчёт (кратко):
- **Дисциплина** = `completed_checkins / total_checkins * 100`
- **Достижение цели (cut)** = `0.7 * прогресс по весу + 0.3 * прогресс по талии`
- **Достижение цели (bulk)** = `0.7 * прогресс по весу + 0.3 * 100`
- **Итог** = `0.7 * goalAchievement + 0.3 * disciplineScore`

Распределение банка:
- если победители есть и есть проигравшие: пул = `проигравшие × ставка`, делится поровну между победителями
- если победили все — всем возвращается ставка
- если победителей нет — всем возвращается ставка

---

## Требования

- **Node.js >= 20** (см. `package.json`)
- npm (или совместимый менеджер пакетов)

> Примечание: зависимость `better-sqlite3` может потребовать нативные инструменты сборки (например, Xcode Command Line Tools на macOS или `build-essential` на Linux), если не найдётся подходящий prebuild.

---

## Быстрый старт (локально)

1) Установить зависимости:
```bash
npm ci
```

2) Создать файл окружения:
```bash
cp .env.example .env
```
Заполнить минимум `BOT_TOKEN`.

3) Запуск в режиме разработки (watch):
```bash
npm run dev
```

По умолчанию база данных создаётся в `./data/fitbet.db`, фото сохраняются в `./data/photos/`.

---

## Сборка и запуск (production)

```bash
npm ci
npm run build
npm start
```

---

## Docker

Сборка образа:
```bash
docker build -t fitbet .
```

Запуск (важно примонтировать каталог `data/`, чтобы сохранялась БД и фото):
```bash
docker run --rm -it \
  --env-file .env \
  -v "$(pwd)/data:/app/data" \
  fitbet
```

---

## Конфигурация (.env)

См. пример: `.env.example`.

| Переменная | Обязательно | По умолчанию | Описание |
|---|---:|---|---|
| `BOT_TOKEN` | да | — | Токен Telegram‑бота (получить у @BotFather) |
| `DATABASE_URL` | нет | `file:./data/fitbet.db` | SQLite: `file:...` или `:memory:` для тестов |
| `OPENROUTER_API_KEY` | нет | — | Ключ OpenRouter для LLM‑валидации/рекомендаций |
| `SENTRY_DSN` | нет | — | DSN проекта в Sentry |
| `NODE_ENV` | нет | `development` | `development | test | production` |
| `ADMIN_TELEGRAM_ID` | нет | — | Telegram ID админа (даёт доступ к `/clear_db`) |
| `CHALLENGE_DURATION_UNIT` | нет | `months` | Единица длительности: `months | days | hours` (удобно для тестов) |
| `CHECKIN_PERIOD_DAYS` | нет | `14` | Период между чек‑инами в днях |
| `CHECKIN_PERIOD_MINUTES` | нет | `0` | Период в минутах (если > 0 — имеет приоритет над днями) |

Про scheduler:
- по умолчанию тикает **каждый час** (в `0` минут),
- если `CHECKIN_PERIOD_MINUTES > 0` и `< 60` — тикает **каждую минуту** (полезно для тестирования),
- таймзона cron‑задач: `Europe/Moscow` (см. `src/scheduler/scheduler.ts`).

---

## Скрипты npm

- `npm run dev` — запуск бота в режиме разработки (watch)
- `npm run build` — сборка TypeScript в `dist/`
- `npm start` — запуск собранной версии
- `npm test` — тесты (Vitest)
- `npm run test:watch` — тесты в watch‑режиме
- `npm run typecheck` — проверка типов без сборки

---

## База данных

Хранилище — SQLite (через `better-sqlite3` + Drizzle ORM).

- Схема создаётся автоматически при старте (см. `src/db/client.ts`), миграции не требуются.
- Для сброса в dev достаточно удалить файл `data/fitbet.db` (или использовать `/clear_db`, если вы админ).

---

## Структура проекта

- `src/index.ts` — точка входа: загрузка env, БД, бот, scheduler
- `src/bot/` — команды, диалоги (conversations), тексты, сессии
- `src/scheduler/` — периодические задачи (окна чек‑инов, напоминания, финализация)
- `src/db/` — схема и клиент БД
- `src/services/` — интеграции (файлы Telegram, OpenRouter и т.д.)
- `src/monitoring/` — Sentry

---

## Разработка и отладка

- Бот использует long polling, поэтому в проде обычно должен работать **один** экземпляр процесса.
- Логи апдейтов включены в `NODE_ENV != test`.
- Для ускоренного прогонки флоу можно выставить `CHALLENGE_DURATION_UNIT=hours` и небольшой `CHECKIN_PERIOD_MINUTES`.

---

## CI

GitHub Actions workflow: `.github/workflows/ci.yml` (typecheck + tests на Node 20).

---

## Лицензия

Лицензия в репозитории не указана.
